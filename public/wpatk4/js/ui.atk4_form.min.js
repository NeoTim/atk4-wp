jQuery.widget("ui.atk4_form",{form:undefined,id:undefined,submitted:undefined,base_url:undefined,loading:false,show_loader:true,plain_submit:false,template:{},_getChanged:function(){return this.form.hasClass("form_changed")},_setChanged:function(state){if(this.element.is(".ignore_changes")){this.form.removeClass("form_changed");return}if(state)this.form.addClass("form_changed");else this.form.removeClass("form_changed")},_create:function(){var self=this;this.id=this.element.attr("id");this.form=this.element;if(!this.form.is("form")){this.form=this.form.find("form");this.element.bind("submit",function(ev){ev.preventDefault();self.submitForm()})}this.form.prepend('<input name="ajax_submit" id="ajax_submit" value="1" type="hidden"/>');this.form.addClass("atk4_form");this.element.addClass("atk4_form_widget");this.form.find("input").bind("keypress",function(e){if(jQuery(this).is(".ui-autocomplete-input"))return true;if(e.keyCode==13){jQuery(this).trigger("change");self.submitForm();return false}});this.form.find(":input").each(function(){if(jQuery(this).attr("type")=="checkbox")jQuery(this).attr("data-initvalue",jQuery(this).attr("checked"));else jQuery(this).attr("data-initvalue",jQuery(this).val())}).bind("change",function(ev){if(jQuery(this).attr("data-initvalue")==jQuery(this).val()){ev.preventDefault();return}else{jQuery(this).attr("data-initvalue",jQuery(this).val())}self._setChanged(true)});this.form.find("input[type=radio]").click(function(){self._setChanged(true)}).change(function(){self._setChanged(true)});this.template["field_error"]=this.element.find(".field-error-template").remove();if(!this.template["field_error"].length)this.form.submit(function(e){if(self.plain_submit){e.stopPropagation();self.plain_submit=false;return}e.stopPropagation();e.preventDefault();self.submitForm()});this.base_url=window.location.href.substr(0,window.location.href.indexOf("#"));if(!this.base_url)this.base_url=window.location.href;if(this.options.base_url)this.base_url=this.options.base_url},submitPlain:function(){this.plain_submit=true;this.form.trigger("submit")},setFieldValue:function(field_name,value){var f=jQuery("#"+this.id+"_"+field_name);if(!f.length){return}if(f.hasClass("field_reference")){var opt=f.find("option[value="+value+"]");if(opt.length){f.val(value).change().trigger("change_ref");return}var self=this;this.reloadField(field_name,null,function(){var f=jQuery("#"+self.id+"_"+field_name);var opt=f.find("option[value="+value+"]");if(opt.length){f.val(value).change().trigger("change_ref")}else{}});return}f.val(value).change()},reloadField:function(field_name,url,fn,notrigger,arg){var field_id=jQuery("#"+this.id+' [data-shortname="'+field_name+'"]').first().attr("id");if(!url)url=this.form.attr("action");if(arg){jQuery.each(arg,function(key,value){url=jQuery.atk4.addArgument(url,key+"="+encodeURIComponent(value))})}url=jQuery.atk4.addArgument(url,this.id+"_cut_field",field_id);var f=jQuery("#"+field_id);if(!notrigger)f.trigger("reload_field");var f2=f.closest(".atk-form-field");f=f2;var c=this._getChanged();this._setChanged(false);f.atk4_load(url,fn);this._setChanged(c)},fieldError:function(field_name,error){if(this.options.error_handler){return this.options.error_handler(field_name,error)}var field=typeof field_name=="string"?jQuery('[data-shortname="'+field_name+'"]',"#"+this.id):field_name;if(!field.length){field=this.form.find('[name="'+field_name+'"]')}if(!field.length){alert("Field not found: "+field_name+", error is: "+error);return}if(!error||error=="0")error="must be specified properly";field.focus();field.closest("form").find(".field_error").remove();var field_row=field.closest(".atk-form-row");field_row.addClass("atk-effect-danger").addClass("has-error");var field_highlight=field_row.find(".atk-form-field");if(!field_highlight.length){field_highlight=field_row}var field_error=field_row.find(".atk-form-error");field_error.remove();if(!this.template["field_error"].length){jQuery.univ().errorMessage(error);return}var error_bl=this.template["field_error"].clone();error_bl.find(".field-error-text").add(error_bl.filter(".field-error-text")).text(error);error_bl.appendTo(field_highlight).fadeIn();this.form.addClass("form_has_error");var self=this;field.on("input paste change",function(e){field.trigger("change.errorhide")});field.on("propertychange",function(e){if(e.originalEvent.propertyName=="value")field.trigger("change.errorhide")});field.bind("change.errorhide",function(e){var t=jQuery(this);t.unbind("change.errorhide");self.form.removeClass("form_has_error");field_row.removeClass("atk-effect-danger");field_highlight.closest(".has-error").removeClass("has-error");error_bl.fadeOut(function(){error_bl.remove()})})},clearError:function(field){if(field){field=field.closest(".has-error")}else{field=this.form.find(".has-error")}field.find(".atk-form-error").remove();field.removeClass("has-error")},submitForm:function(btn){var params={},form=this;if(form.loading){jQuery.univ().loadingInProgress();return false}this.form.trigger("beforesubmit");var richtext=form.element.find(".atk4_richtext");if(richtext.length)richtext.atk4_richtext("changeHTML");params=form.element.find(":input").serializeArray();if(btn){for(var el in params){if(params[el].name=="ajax_submit"){params[el].value=btn;break}}}var properties={type:"POST",url:form.form.attr("action")};form.loading=true;if(form.show_loader){form.element.atk4_loader().atk4_loader("showLoader")}form.element.find(":input:enabled").attr("disabled",true).attr("reenable",true);form.element.find(".atk-effect-danger").removeClass("atk-effect-danger");jQuery.atk4.get(properties,params,function(res){var c=form._getChanged();form._setChanged(false);if(!jQuery.atk4._checkSession(res))return;try{eval(res)}catch(e){w=window.open(null,null,"height=400,width=700,location=no,menubar=no,scrollbars=yes,status=no,titlebar=no,toolbar=no");if(w){w.document.write("<h5>Error in AJAX response: "+e+"</h5>");w.document.write(res);w.document.write('<center><input type=button onclick="window.close()" value="Close"></center>')}else{alert("Error in AJAX response: "+e+"\n"+res)}}form._setChanged(c)},function(){form.loading=false;if(form.show_loader){form.element.atk4_loader().atk4_loader("hideLoader")}form.element.find(":input[reenable]").removeAttr("disabled").removeAttr("reenable")})}});